<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Route Viewer Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU&suppressMapOpenBlock=true"></script>
    <style>
        :root { --bg: var(--tg-theme-bg-color, #000); --btn: var(--tg-theme-button-color, #007AFF); --btn-txt: var(--tg-theme-button-text-color, #fff); }
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, sans-serif; overflow: hidden; background: var(--bg); }
        #map { position: absolute; inset: 0; z-index: 1; }
        
        /* –°–∫—Ä—ã—Ç–∏–µ –ª–∏—à–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ø–Ω–¥–µ–∫—Å–∞ */
        [class*="ymaps-2-1-"][class*="-copyrights-pane"], 
        [class*="ymaps-2-1-"][class*="-map-copyrights-promo"],
        [class*="ymaps-2-1-"][class*="-controls-pane"] {
            display: none !important;
        }

        .filter-container { position: absolute; bottom: 40px; right: 16px; z-index: 2000; display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 12px; }
        .map-btn { width: 56px; height: 56px; border-radius: 50%; background: rgba(0,0,0,.8); backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,.3); box-shadow: 0 4px 20px #0008; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .map-btn svg { fill: white; width: 28px; }
        .map-btn.active { background: var(--btn); border-color: #fff; }

        /* –ú–µ–Ω—é —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å —Ç–µ–∫—Å—Ç–æ–º */
        #filterMenu { background: #fffffffb; border-radius: 20px; box-shadow: 0 10px 30px #0005; padding: 12px; display: none; flex-direction: column; gap: 4px; border: 1px solid #0002; margin-bottom: 8px; min-width: 220px; max-height: 60vh; overflow-y: auto; }
        #filterMenu.active { display: flex; }
        .menu-item { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 8px; border-radius: 10px; }
        .menu-item:active { background: rgba(0,0,0,0.05); }
        .menu-dot { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #0002; flex-shrink: 0; }
        .menu-dot.all { background: linear-gradient(45deg, #ff3b30, #34c759, #007aff); }
        .menu-text { font-size: 14px; color: #000; font-weight: 500; }
        .menu-admin-row { margin-top: 4px; border-top: 1px solid #eee; padding-top: 10px; }

        #infoSheet { position: absolute; bottom: 0; left: 0; right: 0; z-index: 2500; background: #fff; border-radius: 24px 24px 0 0; transform: translateY(100%); transition: transform .3s cubic-bezier(.2,.8,.2,1); max-height: 70vh; overflow-y: auto; padding: 0 20px 30px; color: #000; }
        #infoSheet.active { transform: translateY(0); }
        .sheet-handle { width: 40px; height: 5px; background: #e5e5ea; border-radius: 3px; margin: 12px auto; }
        .path-tabs { display: flex; gap: 10px; overflow-x: auto; justify-content: center; margin-bottom: 15px; }
        .tab-btn { min-width: 48px; height: 48px; border-radius: 16px; border: none; background: #f2f2f7; font-weight: 800; font-size: 17px; }
        .tab-btn.active { background: var(--btn); color: var(--btn-txt); }
        .cmd-container { border-radius: 14px; overflow: hidden; }
        .cmd-item { padding: 16px; border-bottom: 1px solid #f2f2f7; font-size: 17px; display: flex; justify-content: space-between; align-items: center; }
        .cmd-item.preview { background: #f9f9f9; border: 1px solid #eee; font-weight: 600; border-radius: 14px; margin-bottom: 4px; }
        .cmd-item.active-list { border-left: 4px solid var(--btn); }
        .expand-icon { color: var(--btn); font-size: 11px; font-weight: bold; margin-left: 8px; }
        .comm-box { margin-top: 12px; padding: 14px; background: #fff9e6; border-radius: 12px; font-size: 15px; color: #7a5c00; border: 1px solid #ffeeba; }
        .close-sheet { position: absolute; top: 16px; right: 16px; font-size: 28px; border: none; background: none; color: #d1d1d6; }
    </style>
</head>
<body>

<div class="filter-container" id="fCont">
    <div id="filterTrigger" class="map-btn" onclick="toggleMenu()">
        <svg viewBox="0 0 24 24"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/></svg>
    </div>
    <div id="locateBtn" class="map-btn" onclick="toggleAutoCenter()">
        <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
    </div>
    <div id="filterMenu"></div>
</div>

<div id="map"></div>
<div id="infoSheet">
    <div class="sheet-handle"></div>
    <button class="close-sheet" onclick="closeSheet()">√ó</button>
    <div id="sheetContent"></div>
</div>

<script>
const BOT_TOKEN = "7860806384:AAEYRKqdPUsUz9npN3MmyEYKH-rTHISeHbs", CHAT_ID = "5180466640", ADMIN = "Eliseev_I_A";
const DATA_URL = "https://raw.githubusercontent.com/yvayvapyvapyva/test/refs/heads/main/roads/%D0%BF%D0%B5%D1%80%D0%B5%D0%BA%D1%80%D0%B5%D1%81%D1%82%D0%BA%D0%B8.json";

const COLORS = { Gold: '#FFD700', Blue: '#007AFF', Red: '#FF3B30', Lime: '#34C759', Fuchsia: '#AF52DE', Orange: '#FF9500', Purple: '#5856D6', Cyan: '#5AC8FA', Brown: '#A2845E', Grey: '#8E8E93' };

// –û–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –º–µ–Ω—é
const COLOR_LABELS = {
    all: "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë",
    Gold: "–ú–∞–Ω–µ–≤—Ä—ã –Ω–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ",
    Blue: "–†–∞–∑–≤–æ—Ä–æ—Ç –≤–Ω–µ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞",
    Red: "–†–∞–∑–≥–æ–Ω –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏",
    Lime: "-",
    Fuchsia: "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—á–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –ø–æ–¥—ä–µ–º–µ",
    Orange: "–õ–µ–≤—ã–µ –∏ –ø—Ä–∞–≤—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã",
    Purple: "–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞ –∏ –≥–∞—Ä–∞–∂",
    Cyan: "–†–∞–∑–≤–æ—Ä–æ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ",
    Brown: "-",
    Grey: "-"
};

const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();

let map, points = [], currentFilter = 'all';
let userMarker, isAutoCenter = false, isFirstCoordsSent = false;

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –≤—Ö–æ–¥–µ
const sendStats = (u) => {
    const text = `üöÄ *–ù–æ–≤—ã–π –≤—Ö–æ–¥*\nüë§ ${u.first_name}\nüÜî \`${u.id}\`\nüîó @${u.username||'none'}\nüì± ${tg.platform}`;
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(text)}&parse_mode=Markdown`).catch(console.error);
};

// –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–µ–æ–º–µ—Ç–∫–∏ (–µ–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–æ)
const sendGeoLocation = (lat, lon) => {
    if (isFirstCoordsSent) return;
    isFirstCoordsSent = true;
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendLocation?chat_id=${CHAT_ID}&latitude=${lat}&longitude=${lon}`).catch(console.error);
};

ymaps.ready(() => {
    map = new ymaps.Map("map", { 
        center: [56.3399, 43.9332], 
        zoom: 17, 
        type: 'yandex#satellite', 
        controls: [] 
    }, { suppressMapOpenBlock: true });
    
    map.events.add('click', (e) => { if(e.get('target') === map) { closeSheet(); closeMenu(); } });
    map.events.add('mousedown', () => { if(isAutoCenter) toggleAutoCenter(); });

    if (tg.initDataUnsafe?.user) sendStats(tg.initDataUnsafe.user);
    initGeolocation();
    loadData();
});

function initGeolocation() {
    if ("geolocation" in navigator) {
        userMarker = new ymaps.Placemark([0, 0], {}, {
            iconLayout: 'default#imageWithContent',
            iconImageSize: [20, 20], iconImageOffset: [-10, -10],
            iconImageHref: 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="8" fill="#007AFF" stroke="white" stroke-width="2"/></svg>`),
            zIndex: 10000
        });
        map.geoObjects.add(userMarker);
        userMarker.options.set('visible', false);

        navigator.geolocation.watchPosition((pos) => {
            const lat = pos.coords.latitude, lon = pos.coords.longitude;
            userMarker.geometry.setCoordinates([lat, lon]);
            userMarker.options.set('visible', true);
            sendGeoLocation(lat, lon);
            if (isAutoCenter) map.panTo([lat, lon], { flying: true, duration: 300 });
        }, null, { enableHighAccuracy: true });
    }
}

function toggleAutoCenter() {
    isAutoCenter = !isAutoCenter;
    document.getElementById('locateBtn').classList.toggle('active', isAutoCenter);
    if (isAutoCenter && userMarker) {
        const c = userMarker.geometry.getCoordinates();
        if (c[0] !== 0) map.panTo(c, { flying: true });
    }
}

async function loadData() {
    try {
        const res = await fetch(DATA_URL);
        const data = await res.json();
        render(data);
        setupMenu(data);
    } catch (e) { console.error("Error:", e); }
}

function setupMenu(data) {
    const menu = document.getElementById('filterMenu');
    const dataColors = new Set(data.map(d => d.color));
    const uniqueColors = ['all', ...Object.keys(COLOR_LABELS).filter(c => c !== 'all' && dataColors.has(c))];
    
    let menuHtml = uniqueColors.map(c => `
        <div class="menu-item" onclick="applyF('${c}')">
            <div class="menu-dot ${c==='all'?'all':''}" style="background:${COLORS[c]||c}"></div>
            <div class="menu-text">${COLOR_LABELS[c] || c}</div>
        </div>`).join('');

    menuHtml += `
        <div class="menu-item menu-admin-row" onclick="tg.openTelegramLink('https://t.me/${ADMIN}')">
            <span style="font-size:18px">‚úâÔ∏è</span>
            <div class="menu-text" style="color:var(--btn)">–ù–∞–ø–∏—Å–∞—Ç—å –∞–¥–º–∏–Ω—É</div>
        </div>`;
    menu.innerHTML = menuHtml;
}

const toggleMenu = () => document.getElementById('filterMenu').classList.toggle('active');
const closeMenu = () => document.getElementById('filterMenu').classList.remove('active');

window.applyF = (col) => { 
    currentFilter = col; 
    points.forEach(p => p.pm.options.set('visible', col === 'all' || p.colorName === col)); 
    closeMenu(); 
};

function closeSheet() {
    document.getElementById('infoSheet').classList.remove('active');
    document.getElementById('fCont').style.display = 'flex';
    applyF(currentFilter);
    points.forEach(p => p.paths.forEach(obj => { obj.line.options.set('visible', false); obj.pmEnd.options.set('visible', false); }));
}

window.showInitialView = (id) => {
    const p = points.find(x => x.id == id);
    if(!p) return;
    document.getElementById('fCont').style.display = 'none';
    closeMenu();
    points.forEach(pt => pt.pm.options.set('visible', pt.id == id));
    if (p.rawPaths.length === 1) return showPathDetails(id, 0);
    p.paths.forEach(obj => { obj.line.options.set('visible', true); obj.pmEnd.options.set('visible', true); });
    const tabs = `<div class="path-tabs">${p.rawPaths.map((_, i) => `<button class="tab-btn" onclick="showPathDetails(${id}, ${i})">${i+1}</button>`).join('')}</div>`;
    document.getElementById('sheetContent').innerHTML = tabs + '<div style="text-align:center;color:#8e8e93;margin-top:20px">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>';
    document.getElementById('infoSheet').classList.add('active');
};

window.showPathDetails = (id, idx, full = false) => {
    const p = points.find(x => x.id == id), path = p.paths[idx], cmds = path.raw.cmd || [], multi = cmds.length > 1;
    p.paths.forEach((obj, i) => { obj.line.options.set('visible', i === idx); obj.pmEnd.options.set('visible', i === idx); });
    let html = p.rawPaths.length > 1 ? `<div class="path-tabs">${p.rawPaths.map((_, i) => `<button class="tab-btn ${i===idx?'active':''}" onclick="showPathDetails(${id}, ${i})">${i+1}</button>`).join('')}</div>` : '';
    if (!full && multi) {
        html += `<div class="cmd-container" onclick="showPathDetails(${id},${idx},true)"><div class="cmd-item preview"><span>${cmds[0]}</span><span class="expand-icon">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº</span></div></div>`;
    } else {
        html += `<div class="cmd-container" onclick="${multi?'showPathDetails('+id+','+idx+',false)':''}">` + 
                cmds.map((c, i) => `<div class="cmd-item ${i===0?'active-list':''}"><span>${c}</span>${i===0&&multi?'<span class="expand-icon">–°–≤–µ—Ä–Ω—É—Ç—å ‚ñ≤</span>':''}</div>`).join('') + `</div>`;
    }
    document.getElementById('sheetContent').innerHTML = html + (path.raw.comm ? `<div class="comm-box">${path.raw.comm}</div>` : '');
    document.getElementById('infoSheet').classList.add('active');
};

const getSvg = (col, txt, az, isEnd) => {
    const size = isEnd ? 34 : 40, r = isEnd ? 7 : 9, fs = isEnd ? 9 : 8;
    const stroke = isEnd ? 'white' : '#000', sw = isEnd ? 2 : 1.5;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}">
        <g transform="rotate(${az},${size/2},${size/2})"><polygon points="${size/2},2 ${size*0.75},${size-5} ${size/2},${size*0.65} ${size*0.25},${size-5}" fill="${col}" stroke="${stroke}" stroke-width="${sw}"/></g>
        <circle cx="${size/2}" cy="${size/2}" r="${r}" fill="${col}" stroke="${stroke}" stroke-width="1"/>
        <text x="${size/2}" y="${size/2+3}" font-size="${fs}" font-family="Arial" font-weight="bold" text-anchor="middle" fill="#000" stroke="white" stroke-width="2.5" style="paint-order:stroke fill;stroke-linejoin:round">${txt}</text>
    </svg>`);
};

function calculateAngle(p1, p2) {
    if (!p1 || !p2) return 0;
    const dLon = (p2[1] - p1[1]) * Math.PI / 180;
    const lat1 = p1[0] * Math.PI / 180, lat2 = p2[0] * Math.PI / 180;
    const y = Math.sin(dLon) * Math.cos(lat2);
    const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
    return Math.round((Math.atan2(y, x) * 180 / Math.PI + 360) % 360);
}

function render(json) {
    points = [];
    json.forEach(d => {
        const col = COLORS[d.color] || d.color, p = { id: d.id, colorName: d.color, rawPaths: d.paths, paths: [] };
        p.pm = new ymaps.Placemark([d.lat, d.lon], {}, { iconLayout: 'default#imageWithContent', iconImageSize: [40, 40], iconImageOffset: [-20, -20], iconImageHref: getSvg(col, d.id, d.az, false) });
        p.pm.events.add('click', () => showInitialView(d.id));
        d.paths.forEach((pth, i) => {
            const line = new ymaps.Polyline(pth.pts, {}, { strokeColor: col, strokeWidth: 5, strokeOpacity: 0.8, visible: false, interactive: false });
            const az = calculateAngle(pth.pts[pth.pts.length-2], pth.pts[pth.pts.length-1]);
            const pmEnd = new ymaps.Placemark(pth.pts[pth.pts.length-1], {}, { iconLayout: 'default#imageWithContent', iconImageSize: [34, 34], iconImageOffset: [-17, -17], iconImageHref: getSvg(col, i+1, az, true), visible: false, interactive: false });
            p.paths.push({ line, pmEnd, raw: pth });
            map.geoObjects.add(line).add(pmEnd);
        });
        map.geoObjects.add(p.pm); points.push(p);
    });
}
</script>
</body>
</html>
