<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Modern Route Viewer Bottom Sheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU"></script>
    <style>
        body, html { margin: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif; overflow: hidden; background: #000; }
        #map { position: absolute; inset: 0; }
        
        /* Кнопка настроек */
        #togglePanel { 
            position: absolute; top: 15px; right: 15px; z-index: 101; 
            width: 44px; height: 44px; border-radius: 12px; background: #007AFF; 
            color: white; border: none; cursor: pointer; font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
        }

        /* Боковая панель настроек */
        #settingsPanel { 
            position: absolute; top: 70px; right: 15px; width: 260px; z-index: 100;
            background: rgba(255,255,255,0.9); padding: 20px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); backdrop-filter: blur(15px);
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #settingsPanel.hidden { transform: translateX(320px); opacity: 0; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; margin-bottom: 10px; outline: none; box-sizing: border-box;}

        /* НИЖНЯЯ ПАНЕЛЬ (Bottom Sheet) */
        #infoSheet {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
            background: #ffffff; border-radius: 24px 24px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 60vh; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column;
        }
        #infoSheet.active { transform: translateY(0); }

        .sheet-handle { 
            width: 40px; height: 5px; background: #e5e5ea; border-radius: 3px; 
            margin: -10px auto 20px auto; flex-shrink: 0;
        }

        .path-tabs { display: flex; gap: 12px; overflow-x: auto; justify-content: center; flex-wrap: wrap; margin-bottom: 5px; }
        
        .tab-btn { 
            min-width: 48px; height: 48px; border-radius: 16px; border: none;
            background: #f2f2f7; color: #1c1c1e; font-weight: 700; font-size: 17px;
            cursor: pointer; transition: all 0.2s ease; flex-shrink: 0;
        }
        .tab-btn.active { background: #007AFF; color: #fff; box-shadow: 0 4px 12px rgba(0,122,255,0.4); }

        .cmd-list { margin-top: 15px; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .cmd-item { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; font-size: 16px; color: #1d1d1f; line-height: 1.4; }
        .cmd-num { background: #007AFF; color: white; min-width: 24px; height: 24px; border-radius: 8px; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; margin-top: 1px; }

        .comm-box { margin-top: 15px; padding: 14px; background: #fff9e6; border-radius: 16px; font-size: 14px; color: #7a5c00; border: 1px solid #ffeeba; }
        
        .close-sheet { position: absolute; top: 15px; right: 20px; color: #8e8e93; font-size: 28px; cursor: pointer; border: none; background: none; line-height: 1; padding: 5px; }
        
        /* Скроллбар для панели */
        #infoSheet::-webkit-scrollbar { width: 4px; }
        #infoSheet::-webkit-scrollbar-thumb { background: #d1d1d6; border-radius: 10px; }
    </style>
</head>
<body>

<div id="map"></div>
<button id="togglePanel" onclick="document.getElementById('settingsPanel').classList.toggle('hidden')">≡</button>

<div id="settingsPanel" class="hidden">
    <input type="password" id="ghToken" placeholder="GitHub Token" oninput="saveToken(this.value)">
    <select id="fileSelector" onchange="loadFromGH(this.value)">
        <option value="">Выберите файл...</option>
    </select>
</div>

<div id="infoSheet">
    <div class="sheet-handle"></div>
    <button class="close-sheet" onclick="closeSheet()">×</button>
    <div id="sheetContent"></div>
</div>

<script>
const REPO = "yvayvapyvapyva/test", PATH = "roads";
const COLOR_MAP = { Gold: '#FFD700', Blue: '#007AFF', Red: '#FF3B30', Lime: '#34C759', Fuchsia: '#AF52DE', Orange: '#FF9500', Purple: '#5856D6', Cyan: '#5AC8FA', Brown: '#A2845E', Grey: '#8E8E93' };

let map, points = [];

ymaps.ready(() => {
    map = new ymaps.Map("map", { center: [56.3399, 43.9332], zoom: 17, type: 'yandex#satellite', controls: [] });
    const savedToken = localStorage.getItem('gh_t');
    if (savedToken) { document.getElementById('ghToken').value = savedToken; listFiles(); }
});

const api = (u) => fetch(`https://api.github.com/repos/${REPO}/${u}`, {
    headers: { Authorization: `token ${document.getElementById('ghToken').value}` }
}).then(r => r.json());

async function listFiles() {
    try {
        const files = await api(`contents/${PATH}`);
        const sel = document.getElementById('fileSelector');
        sel.innerHTML = '<option value="">Выберите файл...</option>';
        if (Array.isArray(files)) {
            files.filter(f => f.name.endsWith('.json')).forEach(f => {
                const o = document.createElement('option'); o.value = f.path; o.textContent = f.name; sel.appendChild(o);
            });
        }
    } catch (e) {}
}

async function loadFromGH(path) {
    if (!path) return;
    const data = await api(`contents/${path}`);
    const content = JSON.parse(decodeURIComponent(escape(atob(data.content))));
    render(content);
}

function saveToken(v) { localStorage.setItem('gh_t', v); if (v.length > 20) listFiles(); }

function closeSheet() { 
    document.getElementById('infoSheet').classList.remove('active');
    points.forEach(p => p.paths.forEach(obj => { obj.line.options.set('visible', false); obj.pmEnd.options.set('visible', false); }));
}

// Показать выбор или сразу детали
window.showInitialView = function(pointId) {
    const point = points.find(p => p.id == pointId);
    
    // Если путь только один — сразу открываем детали
    if (point.rawPaths.length === 1) {
        showPathDetails(pointId, 0);
        return;
    }

    // Если путей несколько — показываем все линии и кнопки цифр
    points.forEach(pt => pt.paths.forEach(obj => {
        const isTarget = (pt.id === pointId);
        obj.line.options.set('visible', isTarget);
        obj.pmEnd.options.set('visible', isTarget);
    }));

    let tabs = '<div class="path-tabs">';
    point.rawPaths.forEach((_, i) => {
        tabs += `<button class="tab-btn" onclick="showPathDetails(${pointId}, ${i})">${i + 1}</button>`;
    });
    tabs += '</div>';

    document.getElementById('sheetContent').innerHTML = tabs;
    document.getElementById('infoSheet').classList.add('active');
};

// Отображение конкретного маршрута
window.showPathDetails = function(pointId, idx) {
    const point = points.find(p => p.id == pointId);
    const path = point.paths[idx];

    // Скрыть все линии, кроме выбранной
    point.paths.forEach((obj, i) => {
        obj.line.options.set('visible', i === idx);
        obj.pmEnd.options.set('visible', i === idx);
    });

    // Формируем кнопки цифр (только если путей > 1)
    let tabs = '';
    if (point.rawPaths.length > 1) {
        tabs = '<div class="path-tabs">';
        point.rawPaths.forEach((_, i) => {
            tabs += `<button class="tab-btn ${i === idx ? 'active' : ''}" onclick="showPathDetails(${pointId}, ${i})">${i + 1}</button>`;
        });
        tabs += '</div>';
    }

    const cmds = (path.raw.cmd || []).map((c, i) => 
        `<div class="cmd-item"><div class="cmd-num">${i+1}</div><div>${c}</div></div>`
    ).join('');

    const html = `
        ${tabs}
        <div class="cmd-list">
            ${cmds}
            ${path.raw.comm ? `<div class="comm-box">${path.raw.comm}</div>` : ''}
        </div>
    `;

    document.getElementById('sheetContent').innerHTML = html;
    document.getElementById('infoSheet').classList.add('active');
    document.getElementById('infoSheet').scrollTop = 0; // Скролл вверх
};

function calculateAngle(p1, p2) {
    if (!p1 || !p2) return 0;
    const dLon = (p2[1] - p1[1]) * Math.PI / 180;
    const y = Math.sin(dLon) * Math.cos(p2[0] * Math.PI / 180);
    const x = Math.cos(p1[0] * Math.PI / 180) * Math.sin(p2[0] * Math.PI / 180) - Math.sin(p1[0] * Math.PI / 180) * Math.cos(p2[0] * Math.PI / 180) * Math.cos(dLon);
    return Math.round((Math.atan2(y, x) * 180 / Math.PI + 360) % 360);
}

function render(json) {
    map.geoObjects.removeAll();
    points = [];
    closeSheet();
    document.getElementById('settingsPanel').classList.add('hidden');

    json.forEach(d => {
        const p = { id: d.id, rawPaths: d.paths, paths: [] };
        const col = COLOR_MAP[d.color] || d.color;
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><g transform="rotate(${d.az},20,20)"><polygon points="20,2 35,35 20,26 5,35" fill="${col}" stroke="#000" stroke-width="1.5"/></g><circle cx="20" cy="20" r="7" fill="#fff" stroke="#000" stroke-width="1"/><text x="20" y="24" font-size="10" font-family="Arial" font-weight="bold" text-anchor="middle">${d.id}</text></svg>`;

        p.pm = new ymaps.Placemark([d.lat, d.lon], {}, {
            iconLayout: 'default#imageWithContent', iconImageSize: [40, 40], iconImageOffset: [-20, -20],
            iconImageHref: 'data:image/svg+xml;utf8,' + encodeURIComponent(svg)
        });

        p.pm.events.add('click', () => showInitialView(d.id));

        d.paths.forEach((pathData, i) => {
            const line = new ymaps.Polyline(pathData.pts, {}, { strokeColor: col, strokeWidth: 5, strokeOpacity: 0.8, visible: false, interactive: false });
            const lastPt = pathData.pts[pathData.pts.length - 1];
            const prevPt = pathData.pts[pathData.pts.length - 2];
            const finalAz = prevPt ? calculateAngle(prevPt, lastPt) : 0;
            const numSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="34" height="34"><g transform="rotate(${finalAz},17,17)"><polygon points="17,2 30,30 17,22 4,30" fill="${col}" stroke="white" stroke-width="2.5"/></g><circle cx="17" cy="17" r="8" fill="white" stroke="${col}" stroke-width="2.5"/><text x="17" y="21" font-size="11" font-family="Arial" font-weight="900" text-anchor="middle" fill="#000">${i + 1}</text></svg>`;

            const pmEnd = new ymaps.Placemark(lastPt, {}, {
                iconLayout: 'default#imageWithContent', iconImageSize: [34, 34], iconImageOffset: [-17, -17],
                iconImageHref: 'data:image/svg+xml;utf8,' + encodeURIComponent(numSvg), visible: false, interactive: false
            });

            p.paths.push({ line, pmEnd, raw: pathData });
            map.geoObjects.add(line).add(pmEnd);
        });

        map.geoObjects.add(p.pm);
        points.push(p);
    });
    if (points.length) map.setCenter([json[0].lat, json[0].lon]);
}
</script>
</body>
</html>
