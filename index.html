<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Route Viewer Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU&suppressMapOpenBlock=true"></script>
    <style>
        :root { 
            --bg: var(--tg-theme-bg-color, #f5f5f7); 
            --btn: var(--tg-theme-button-color, #007AFF); 
            --btn-txt: var(--tg-theme-button-text-color, #fff);
            --sheet-bg: rgba(255, 255, 255, 0.9);
            --text-main: #1d1d1f;
            --text-sub: #86868b;
            --accent: #007AFF;
            --card-bg: #ffffff;
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            overflow: hidden; background: #000; 
            position: fixed; touch-action: none;
        }

        #map { position: absolute; inset: 0; z-index: 1; touch-action: auto; }
        [class*="-copyrights-pane"], [class*="-map-copyrights-promo"], [class*="-controls-pane"] { display: none !important; }

        .filter-container { position: absolute; bottom: 40px; right: 16px; z-index: 2000; display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 12px; transition: opacity 0.3s ease, transform 0.3s ease; }
        .filter-container.hidden-state { opacity: 0; pointer-events: none; transform: translateX(20px); }

        .map-btn { width: 56px; height: 56px; border-radius: 50%; background: rgba(0,0,0,.75); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 8px 32px rgba(0,0,0,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .map-btn:active { transform: scale(0.9); }
        .map-btn svg { fill: white; width: 26px; pointer-events: none; }
        .map-btn.active { background: var(--btn); border-color: transparent; }

        #filterMenu { background: var(--sheet-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); padding: 8px; display: none; flex-direction: column; gap: 2px; border: 1px solid rgba(255,255,255,0.4); margin-bottom: 12px; min-width: 260px; max-height: 60vh; overflow-y: auto; pointer-events: auto; }
        #filterMenu.active { display: flex; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .menu-item { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 12px 16px; border-radius: 16px; transition: background 0.2s; }
        .menu-item:active { background: rgba(0,0,0,0.05); }
        .menu-dot { width: 14px; height: 14px; border-radius: 4px; flex-shrink: 0; }
        .menu-dot.all { background: linear-gradient(135deg, #007aff, #5856d6, #ff2d55); }
        .menu-text { font-size: 15px; color: var(--text-main); font-weight: 500; }

        .source-selector-container {
            padding: 8px 8px 12px 8px;
            margin-bottom: 4px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .source-select {
            width: 100%;
            padding: 12px;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,0.1);
            background: #fff;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-main);
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 16px;
        }

        #infoSheet { position: absolute; bottom: 0; left: 0; right: 0; z-index: 2500; background: var(--sheet-bg); backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border-radius: 32px 32px 0 0; height: auto; max-height: 85vh; transform: translateY(110%); transition: transform .4s cubic-bezier(0.16, 1, 0.3, 1); padding: 0 16px 40px; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); box-sizing: border-box; will-change: transform; display: flex; flex-direction: column; }
        #infoSheet.active { transform: translateY(0); }
        #infoSheet.collapsed { transform: translateY(calc(100% - 56px)); }

        #sheetScrollContainer { overflow-y: auto; flex: 1; padding-right: 4px; }
        .sheet-header { width: 100%; height: 56px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: transparent; z-index: 10; -webkit-tap-highlight-color: transparent; }
        .sheet-handle { width: 40px; height: 5px; background: rgba(0,0,0,0.15); border-radius: 3px; transition: all 0.2s; }
        
        .cmd-group { position: relative; margin-bottom: 12px; border-radius: 20px; background: var(--card-bg); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(0,0,0,0.05); overflow: hidden; pointer-events: auto; }
        #sheetContent.has-selection .cmd-group:not(.active-path) { opacity: 0.4; transform: scale(0.97); filter: grayscale(0.3); }
        .cmd-group.active-path { box-shadow: 0 12px 30px rgba(0,0,0,0.08); border-color: var(--accent); opacity: 1 !important; transform: scale(1) !important; filter: none !important; }
        
        .cmd-main-row { display: flex; align-items: center; padding: 16px; gap: 12px; }
        .cmd-info { flex: 1; cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .cmd-num-circle { width: 28px; height: 28px; border-radius: 50%; background: rgba(0,122,255,0.08); color: var(--accent); font-size: 14px; font-weight: 800; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .active-path .cmd-num-circle { background: var(--accent); color: #fff; }
        .cmd-title { font-size: 16px; font-weight: 700; color: var(--text-main); line-height: 1.2; }
        
        .action-bar { display: flex; gap: 4px; flex-shrink: 0; }
        .icon-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; cursor: pointer; color: var(--text-sub); }
        .icon-btn.active { color: var(--accent); background: rgba(0,122,255,0.08); }
        .icon-btn.has-data { color: #ff9500; background: rgba(255,149,0,0.05); }

        .nested-content { padding: 0 16px 20px 16px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }

        .comm-text { font-size: 14px; color: #444; line-height: 1.5; padding: 12px; background: #fff9eb; border-radius: 12px; border-left: 4px solid #ff9500; margin-bottom: 16px; }
        .sub-steps { display: flex; flex-direction: column; gap: 12px; }
        .step-item { font-size: 15px; color: var(--text-main); font-weight: 500; display: flex; align-items: flex-start; gap: 10px; line-height: 1.4; padding: 8px 12px; background: rgba(0,0,0,0.02); border-radius: 10px; }
        .step-num { width: 20px; height: 20px; border-radius: 50%; background: rgba(0,122,255,0.1); color: var(--accent); font-size: 11px; font-weight: 800; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="filter-container" id="fCont">
    <div id="filterTrigger" class="map-btn" onclick="toggleMenu()">
        <svg viewBox="0 0 24 24"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/></svg>
    </div>
    <div id="locateBtn" class="map-btn" onclick="toggleAutoCenter()">
        <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
    </div>
    <div id="filterMenu"></div>
</div>

<div id="infoSheet">
    <div class="sheet-header" id="sheetHeader" onclick="toggleSheetCollapse()">
        <div class="sheet-handle"></div>
    </div>
    <div id="sheetScrollContainer">
        <div id="sheetContent"></div>
    </div>
</div>

<script>
const tg = window.Telegram.WebApp;

function initTelegram() {
    tg.ready();
    tg.expand();
    if (tg.isVersionAtLeast('7.0')) {
        try { tg.requestFullscreen(); } catch (e) {}
    }
    if (tg.isVersionAtLeast('6.1')) {
        tg.setHeaderColor('#000000');
        tg.setBackgroundColor('#000000');
    }
}
initTelegram();

const DATA_SOURCES = [
    { name: "–ú–µ—â–µ—Ä–∞", url: "https://raw.githubusercontent.com/yvayvapyvapyva/test/refs/heads/main/roads/–ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∏.json" },
    { name: "–ö—É–∑–Ω–µ—á–∏—Ö–∞", url: "https://raw.githubusercontent.com/yvayvapyvapyva/test/refs/heads/main/roads/–∫—É–∑–Ω–µ—á–∏—Ö–∞.json" }
];

const CFG = {
    BOT_TOKEN: "7860806384:AAEYRKqdPUsUz9npN3MmyEYKH-rTHISeHbs",
    CHAT_ID: "5180466640",
    ADMIN: "Eliseev_I_A",
    COLORS: { Gold: '#FFD700', Blue: '#007AFF', Red: '#FF3B30', Lime: '#34C759', Fuchsia: '#AF52DE', Orange: '#FF9500', Purple: '#5856D6', Cyan: '#5AC8FA', Brown: '#A2845E', Grey: '#8E8E93' },
    LABELS: { all: "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë", Gold: "–ú–∞–Ω–µ–≤—Ä—ã –Ω–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ", Blue: "–†–∞–∑–≤–æ—Ä–æ—Ç –≤–Ω–µ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞", Red: "–†–∞–∑–≥–æ–Ω –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏", Fuchsia: "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—á–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –ø–æ–¥—ä–µ–º–µ", Orange: "–õ–µ–≤—ã–µ –∏ –ø—Ä–∞–≤—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã", Purple: "–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞ –∏ –≥–∞—Ä–∞–∂", Cyan: "–†–∞–∑–≤–æ—Ä–æ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ" }
};

let map, pointsData = [], userMarker, objectManager, pathsCollection;
let state = { 
    filter: 'all', 
    activeId: null, 
    pathIdx: -1, 
    expIdx: -1, 
    commIdx: -1, 
    autoCenter: false, 
    statsSent: false,
    currentDataSource: DATA_SOURCES[0].url
};

const ui = {
    menu: document.getElementById('filterMenu'),
    sheet: document.getElementById('infoSheet'),
    header: document.getElementById('sheetHeader'),
    content: document.getElementById('sheetContent'),
    scroll: document.getElementById('sheetScrollContainer'),
    fCont: document.getElementById('fCont'),
    locate: document.getElementById('locateBtn')
};

const iconCache = new Map();

ymaps.ready(() => {
    try {
        map = new ymaps.Map("map", { 
            center: [55.75, 37.62], zoom: 11, type: 'yandex#satellite', controls: [] 
        }, { yandexMapDisablePoiInteractivity: true, suppressMapOpenBlock: true });
        
        objectManager = new ymaps.ObjectManager({ clusterize: false });
        pathsCollection = new ymaps.GeoObjectCollection();
        map.geoObjects.add(objectManager);
        map.geoObjects.add(pathsCollection);
        
        objectManager.objects.events.add('click', e => showPoint(e.get('objectId')));
        map.events.add('click', e => { 
            if (e.get('target') === map) { 
                if(ui.sheet.classList.contains('active') || ui.sheet.classList.contains('collapsed')) closeSheet(); 
                toggleMenu(false); 
            } 
        });
        
        initGeo();
        loadData(state.currentDataSource);
    } catch (e) { console.error(e); }
});

async function loadData(url) {
    try {
        // –û—á–∏—â–∞–µ–º –∫—ç—à –∏–∫–æ–Ω–æ–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ñ–∞–π–ª–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        iconCache.clear();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
        state.filter = 'all';
        objectManager.removeAll();
        pathsCollection.removeAll();
        pointsData = [];
        
        const response = await fetch(url);
        if (!response.ok) throw new Error("Load failed");
        
        const data = await response.json();
        const features = [];
        pointsData = data.map(d => {
            const hex = CFG.COLORS[d.color] || d.color;
            const hasComm = d.paths?.some(p => p.comm);
            features.push({
                type: 'Feature', id: d.id,
                geometry: { type: 'Point', coordinates: [d.lat, d.lon] },
                options: {
                    iconLayout: 'default#imageWithContent', iconImageSize: [40, 40], iconImageOffset: [-20, -20],
                    // –î–æ–±–∞–≤–ª—è–µ–º URL –≤ –∫–ª—é—á –∏–∫–æ–Ω–∫–∏ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
                    iconImageHref: getIcon(hex, `${d.id}${hasComm?'!':''}`, d.az, false, url)
                },
                properties: { color: d.color }
            });
            return { ...d, hex };
        });
        objectManager.add(features);
        
        const bounds = objectManager.getBounds();
        if (bounds) map.setBounds(bounds, { zoomMargin: 60, duration: 800 });
        
        renderMenu(data);
    } catch (e) { 
        console.error(e);
    }
}

function getIcon(col, txt, az, isEnd, sourceUrl = '') {
    // –í–∫–ª—é—á–∞–µ–º sourceUrl –≤ –∫–ª—é—á, —á—Ç–æ–±—ã –∏–∫–æ–Ω–∫–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–ª–∏—Å—å
    const key = `${sourceUrl}-${col}-${txt}-${az}-${isEnd}`;
    if (iconCache.has(key)) return iconCache.get(key);
    
    const isRed = txt.includes('!');
    const s = isEnd ? 34 : 40, c = s/2, t = txt.replace('!', '');
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}"><g transform="rotate(${az},${c},${c})"><polygon points="${c},2 ${c+10},${s-5} ${c},${s-14} ${c-10},${s-5}" fill="${col}" stroke="${isEnd?'white':'black'}" stroke-width="1.5"/></g><circle cx="${c}" cy="${c}" r="${isEnd?7:9}" fill="${col}" stroke="${isEnd?'white':'black'}" stroke-width="1"/><text x="${c}" y="${c + 0.5}" font-size="9" font-family="Arial" font-weight="900" text-anchor="middle" dominant-baseline="middle" fill="${isRed?'#FF3B30':'#000'}" stroke="white" stroke-width="2" style="paint-order:stroke fill">${t}</text></svg>`;
    const res = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    iconCache.set(key, res);
    return res;
}

window.showPoint = (id) => {
    state = { ...state, activeId: id, pathIdx: -1, expIdx: -1, commIdx: -1 };
    ui.fCont.classList.add('hidden-state');
    objectManager.setFilter(obj => obj.id == id);
    const p = pointsData.find(x => x.id == id);
    if(p) drawPathsForPoint(p);
    ui.sheet.classList.remove('collapsed');
    ui.sheet.classList.add('active');
    renderSheet();
};

window.closeSheet = () => {
    ui.sheet.classList.remove('active', 'collapsed');
    pathsCollection.removeAll();
    applyFilter(state.filter);
    ui.fCont.classList.remove('hidden-state');
    state.activeId = null;
};

window.applyFilter = (col) => {
    state.filter = col;
    objectManager.setFilter(col === 'all' ? null : obj => obj.properties.color === col);
    toggleMenu(false);
};

function drawPathsForPoint(point) {
    pathsCollection.removeAll();
    point.paths.forEach((pth, i) => {
        const pts = pth.pts, last = pts.length - 1;
        const az = calcAz(pts[last-1], pts[last]);
        const line = new ymaps.Polyline(pts, {}, { strokeColor: point.hex, strokeWidth: 5, strokeOpacity: 0.8, interactive: false });
        const pmEnd = new ymaps.Placemark(pts[last], {}, {
            iconLayout: 'default#imageWithContent', iconImageSize: [34, 34], iconImageOffset: [-17, -17],
            iconImageHref: getIcon(point.hex, String(i+1), az, true, state.currentDataSource), interactive: false
        });
        pth.mapObjects = { line, pmEnd };
        pathsCollection.add(line).add(pmEnd);
    });
}

function renderSheet() {
    const p = pointsData.find(x => x.id == state.activeId);
    if (!p) return;
    ui.content.classList.toggle('has-selection', state.pathIdx !== -1);
    ui.content.innerHTML = p.paths.map((path, i) => {
        const isSel = state.pathIdx === i, isExp = state.expIdx === i, isComm = state.commIdx === i;
        if (path.mapObjects) {
            const vis = state.pathIdx === -1 || isSel;
            path.mapObjects.line.options.set('visible', vis);
            path.mapObjects.pmEnd.options.set('visible', vis);
        }
        const cmds = Array.isArray(path.cmd) ? path.cmd : [];
        const title = isExp ? `–í–ê–†–ò–ê–ù–¢–´ –ö–û–ú–ê–ù–î` : (cmds[0] || `–ú–∞—Ä—à—Ä—É—Ç ${i+1}`);
        return `
        <div class="cmd-group ${isSel?'active-path':''}">
            <div class="cmd-main-row">
                <div class="cmd-info" onclick="handlePath(${i})">
                    <div class="cmd-num-circle">${i+1}</div>
                    <div class="cmd-title">${title}</div>
                </div>
                <div class="action-bar">
                    ${path.comm ? `<div class="icon-btn ${isComm?'active':'has-data'}" onclick="handleUI('commIdx', ${i})"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>` : ''}
                    ${cmds.length > 1 ? `<div class="icon-btn ${isExp?'active':''}" onclick="handleUI('expIdx', ${i})"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></div>` : ''}
                </div>
            </div>
            ${(isComm || isExp) ? `<div class="nested-content">${isComm ? `<div class="comm-text">${path.comm}</div>` : ''}${isExp ? `<div class="sub-steps">${cmds.map((c, idx) => `<div class="step-item"><div class="step-num">${idx + 1}</div><div style="flex:1">${c}</div></div>`).join('')}</div>` : ''}</div>` : ''}
        </div>`;
    }).join('');
}

window.toggleMenu = (val) => ui.menu.classList.toggle('active', val ?? !ui.menu.classList.contains('active'));
window.toggleSheetCollapse = () => {
    if (ui.sheet.classList.contains('active')) ui.sheet.classList.replace('active', 'collapsed');
    else if (ui.sheet.classList.contains('collapsed')) ui.sheet.classList.replace('collapsed', 'active');
};
window.handleUI = (key, val) => {
    state.pathIdx = val;
    state[key === 'expIdx' ? 'commIdx' : 'expIdx'] = -1;
    state[key] = state[key] === val ? -1 : val;
    renderSheet();
};
window.handlePath = (idx) => {
    state.pathIdx = state.pathIdx === idx ? -1 : idx;
    state.expIdx = state.commIdx = -1;
    renderSheet();
};

function renderMenu(data) {
    const used = new Set(data.map(d => d.color));
    const filterItems = ['all', ...Object.keys(CFG.LABELS).filter(c => used.has(c))];
    
    let menuHtml = `
    <div class="source-selector-container">
        <select class="source-select" onchange="changeDataSource(this.value)">
            ${DATA_SOURCES.map(src => `<option value="${src.url}" ${state.currentDataSource === src.url ? 'selected' : ''}>${src.name}</option>`).join('')}
        </select>
    </div>`;

    menuHtml += filterItems.map(c => `
        <div class="menu-item" onclick="applyFilter('${c}')">
            <div class="menu-dot ${c==='all'?'all':''}" style="background:${CFG.COLORS[c]||''}"></div>
            <div class="menu-text">${CFG.LABELS[c]||c}</div>
        </div>`).join('');
    
    menuHtml += `
    <div class="menu-item" style="border-top:1px solid rgba(0,0,0,0.05); margin-top:4px; padding-top:16px;" onclick="contactAdmin()">
        <span style="font-size:18px">‚úâÔ∏è</span><div class="menu-text" style="color:var(--btn)">–ù–∞–ø–∏—Å–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</div>
    </div>`;
    
    ui.menu.innerHTML = menuHtml;
}

window.changeDataSource = (url) => {
    state.currentDataSource = url;
    loadData(url);
    toggleMenu(false);
};

function initGeo() {
    if (!navigator.geolocation) return;
    userMarker = new ymaps.Placemark([0,0], {}, { iconLayout: 'default#imageWithContent', iconImageSize: [22,22], iconImageOffset: [-11,-11], iconImageHref: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"><circle cx="11" cy="11" r="7" fill="#007AFF" stroke="white" stroke-width="3"/><circle cx="11" cy="11" r="11" fill="rgba(0,122,255,0.2)"/></svg>'), zIndex: 999, visible: false });
    map.geoObjects.add(userMarker);

    const geoTimeout = setTimeout(() => {
        if (!state.statsSent && tg.initDataUnsafe?.user) sendStats(tg.initDataUnsafe.user);
    }, 3000);

    navigator.geolocation.watchPosition(p => {
        clearTimeout(geoTimeout);
        const coords = [p.coords.latitude, p.coords.longitude];
        userMarker.geometry.setCoordinates(coords);
        userMarker.options.set('visible', true);
        if (state.autoCenter) map.panTo(coords);
        
        if (!state.statsSent && tg.initDataUnsafe?.user) {
            sendStats(tg.initDataUnsafe.user, coords);
        }
    }, () => {
        clearTimeout(geoTimeout);
        if (!state.statsSent && tg.initDataUnsafe?.user) sendStats(tg.initDataUnsafe.user);
    }, { enableHighAccuracy: true });
}

window.toggleAutoCenter = () => { state.autoCenter = !state.autoCenter; ui.locate.classList.toggle('active', state.autoCenter); };
window.contactAdmin = () => tg.openTelegramLink(`https://t.me/${CFG.ADMIN}`);

const calcAz = (p1, p2) => {
    if (!p1 || !p2) return 0;
    const dy = p2[0] - p1[0], dx = Math.cos(Math.PI/180 * p1[0]) * (p2[1] - p1[1]);
    return Math.round((Math.atan2(dx, dy) * 180 / Math.PI + 360) % 360);
};

const sendStats = async (u, coords) => {
    if (state.statsSent) return;
    state.statsSent = true;
    const msg = `üöÄ *Route Viewer*\nüë§ ${u.first_name}\nüÜî \`${u.id}\`\nüîó @${u.username||'none'}\nüì± ${tg.platform}`;
    try {
        await fetch(`https://api.telegram.org/bot${CFG.BOT_TOKEN}/sendMessage?chat_id=${CFG.CHAT_ID}&text=${encodeURIComponent(msg)}&parse_mode=Markdown&disable_web_page_preview=true`);
        if (coords) {
            await fetch(`https://api.telegram.org/bot${CFG.BOT_TOKEN}/sendLocation?chat_id=${CFG.CHAT_ID}&latitude=${coords[0]}&longitude=${coords[1]}`);
        }
    } catch (e) {}
};
</script>
</body>
</html>
