<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Route Viewer Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU&suppressMapOpenBlock=true"></script>
    <style>
        :root { --bg: var(--tg-theme-bg-color, #000); --btn: var(--tg-theme-button-color, #007AFF); --btn-txt: var(--tg-theme-button-text-color, #fff); }
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, system-ui, sans-serif; overflow: hidden; background: var(--bg); }
        #map { position: absolute; inset: 0; z-index: 1; }
        [class*="-copyrights-pane"], [class*="-map-copyrights-promo"], [class*="-controls-pane"] { display: none !important; }

        .filter-container { position: absolute; bottom: 40px; right: 16px; z-index: 2000; display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 12px; }
        .map-btn { width: 56px; height: 56px; border-radius: 50%; background: rgba(0,0,0,.8); backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,.3); box-shadow: 0 4px 20px #0008; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: scale 0.2s; }
        .map-btn svg { fill: white; width: 28px; }
        .map-btn.active { background: var(--btn); border-color: #fff; }

        #filterMenu { background: #fffffffb; border-radius: 20px; box-shadow: 0 10px 30px #0005; padding: 12px; display: none; flex-direction: column; gap: 4px; border: 1px solid #0002; margin-bottom: 8px; min-width: 220px; max-height: 60vh; overflow-y: auto; }
        #filterMenu.active { display: flex; }
        .menu-item { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 10px; border-radius: 12px; }
        .menu-dot { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #0002; }
        .menu-dot.all { background: linear-gradient(45deg, #ff3b30, #34c759, #007aff); }
        .menu-text { font-size: 14px; color: #000; font-weight: 500; }

        #infoSheet { position: absolute; bottom: 0; left: 0; right: 0; z-index: 2500; background: #fff; border-radius: 24px 24px 0 0; transform: translateY(100%); transition: transform .3s cubic-bezier(.2,.8,.2,1); max-height: 80vh; overflow-y: auto; padding: 0 20px 30px; color: #000; }
        #infoSheet.active { transform: translateY(0); }
        .sheet-handle { width: 40px; height: 5px; background: #e5e5ea; border-radius: 3px; margin: 12px auto; }
        
        .cmd-group { border-radius: 14px; overflow: hidden; background: #f2f2f7; border: 2px solid transparent; margin-top: 8px; }
        .cmd-group.active-path { border-color: var(--btn); background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .cmd-main-row { display: flex; align-items: stretch; min-height: 60px; background: #fff; }
        .cmd-text-area { flex: 1; padding: 12px 16px; display: flex; align-items: center; font-size: 15px; font-weight: 600; cursor: pointer; }
        
        .info-icon-btn { width: 44px; display: flex; align-items: center; justify-content: center; color: #FF9500; cursor: pointer; }
        .expand-btn { width: 50px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.03); border-left: 1px solid #eee; cursor: pointer; color: var(--btn); }
        .expand-btn svg { transition: transform 0.3s; width: 20px; }
        .expand-btn.open svg { transform: rotate(180deg); }

        .sub-cmds { background: #f9f9f9; padding: 4px 0; border-top: 1px solid #eee; }
        .sub-item { padding: 10px 16px 10px 40px; font-size: 14px; color: #444; position: relative; border-bottom: 1px solid #f0f0f0; }
        .sub-item::before { content: "‚Ä¢"; position: absolute; left: 22px; color: var(--btn); font-weight: bold; }
        .comm-box { padding: 12px 16px; background: #fff9e6; font-size: 14px; color: #7a5c00; border-top: 1px solid #ffeeba; font-style: italic; }
        .close-sheet { position: absolute; top: 16px; right: 16px; font-size: 28px; border: none; background: none; color: #d1d1d6; cursor: pointer; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="filter-container" id="fCont">
    <div id="filterTrigger" class="map-btn" onclick="toggleMenu()">
        <svg viewBox="0 0 24 24"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/></svg>
    </div>
    <div id="locateBtn" class="map-btn" onclick="toggleAutoCenter()">
        <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
    </div>
    <div id="filterMenu"></div>
</div>

<div id="infoSheet">
    <div class="sheet-handle"></div>
    <button class="close-sheet" onclick="closeSheet()">√ó</button>
    <div id="sheetContent"></div>
</div>

<script>
const CFG = {
    BOT_TOKEN: "7860806384:AAEYRKqdPUsUz9npN3MmyEYKH-rTHISeHbs",
    CHAT_ID: "5180466640",
    ADMIN: "Eliseev_I_A",
    DATA_URL: "https://raw.githubusercontent.com/yvayvapyvapyva/test/refs/heads/main/roads/%D0%BF%D0%B5%D1%80%D0%B5%D0%BA%D1%80%D0%B5%D1%81%D1%82%D0%BA%D0%B8.json",
    COLORS: { Gold: '#FFD700', Blue: '#007AFF', Red: '#FF3B30', Lime: '#34C759', Fuchsia: '#AF52DE', Orange: '#FF9500', Purple: '#5856D6', Cyan: '#5AC8FA', Brown: '#A2845E', Grey: '#8E8E93' },
    LABELS: { all: "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë", Gold: "–ú–∞–Ω–µ–≤—Ä—ã –Ω–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ", Blue: "–†–∞–∑–≤–æ—Ä–æ—Ç –≤–Ω–µ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞", Red: "–†–∞–∑–≥–æ–Ω –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏", Fuchsia: "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—á–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –ø–æ–¥—ä–µ–º–µ", Orange: "–õ–µ–≤—ã–µ –∏ –ø—Ä–∞–≤—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã", Purple: "–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞ –∏ –≥–∞—Ä–∞–∂", Cyan: "–†–∞–∑–≤–æ—Ä–æ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ" }
};

let map, points = [], userMarker, pointCollection;
let state = { filter: 'all', activeId: null, pathIdx: -1, expIdx: -1, commIdx: -1, autoCenter: false, geoSent: false };

const ui = {
    menu: document.getElementById('filterMenu'),
    sheet: document.getElementById('infoSheet'),
    content: document.getElementById('sheetContent'),
    fCont: document.getElementById('fCont'),
    locate: document.getElementById('locateBtn')
};

const tg = window.Telegram.WebApp;

const sendStats = (u) => {
    const text = `üöÄ *–ù–æ–≤—ã–π –≤—Ö–æ–¥*\nüë§ ${u.first_name}\nüÜî \`${u.id}\`\nüîó ${u.username||'–Ω–µ—Ç'}\nüì± ${tg.platform}\nüåü –ü—Ä–µ–º–∏—É–º: ${u.is_premium?'–î–∞':'–ù–µ—Ç'}`;
    fetch(`https://api.telegram.org/bot${CFG.BOT_TOKEN}/sendMessage?chat_id=${CFG.CHAT_ID}&text=${encodeURIComponent(text)}&parse_mode=Markdown`).catch(() => {});
};

const getIcon = (col, txt, az, isEnd) => {
    const isRed = txt.includes('!') && !isEnd;
    const size = isEnd ? 34 : 40;
    const center = size / 2;
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}"><g transform="rotate(${az},${center},${center})"><polygon points="${center},2 ${center+10},${size-5} ${center},${size-14} ${center-10},${size-5}" fill="${col}" stroke="${isEnd?'white':'black'}" stroke-width="1.5"/></g><circle cx="${center}" cy="${center}" r="${isEnd?7:9}" fill="${col}" stroke="${isEnd?'white':'black'}" stroke-width="1"/><text x="${center}" y="${center}" font-size="9" font-family="Arial" font-weight="900" text-anchor="middle" dominant-baseline="central" fill="${isRed?'#FF3B30':'#000'}" stroke="white" stroke-width="2" style="paint-order:stroke fill">${txt.replace('!','')}</text></svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
};

ymaps.ready(() => {
    map = new ymaps.Map("map", { center: [55.75, 37.62], zoom: 10, type: 'yandex#satellite', controls: [] });
    pointCollection = new ymaps.GeoObjectCollection();
    
    map.events.add('click', e => e.get('target') === map && (closeSheet(), toggleMenu(false)));
    tg.ready(); tg.expand();
    if (tg.initDataUnsafe?.user) sendStats(tg.initDataUnsafe.user);
    initGeo();
    loadData();
});

async function loadData() {
    try {
        const data = await (await fetch(CFG.DATA_URL)).json();
        points = data.map(d => {
            const col = CFG.COLORS[d.color] || d.color;
            const p = { id: d.id, color: d.color, paths: [] };
            p.pm = new ymaps.Placemark([d.lat, d.lon], {}, {
                iconLayout: 'default#imageWithContent', iconImageSize: [40, 40], iconImageOffset: [-20, -20],
                iconImageHref: getIcon(col, `${d.id}${d.paths?.some(p=>p.comm)?'!':''}`, d.az, false)
            });
            p.pm.events.add('click', () => showPoint(d.id));
            pointCollection.add(p.pm);

            d.paths.forEach((pth, i) => {
                const last = pth.pts.length - 1;
                const az = calcAz(pth.pts[last-1], pth.pts[last]);
                const line = new ymaps.Polyline(pth.pts, {}, { strokeColor: col, strokeWidth: 5, strokeOpacity: 0.8, visible: false, interactive: false });
                const pmEnd = new ymaps.Placemark(pth.pts[last], {}, {
                    iconLayout: 'default#imageWithContent', iconImageSize: [34, 34], iconImageOffset: [-17, -17],
                    iconImageHref: getIcon(col, String(i+1), az, true), visible: false, interactive: false
                });
                p.paths.push({ line, pmEnd, raw: pth });
                map.geoObjects.add(line).add(pmEnd);
            });
            return p;
        });

        map.geoObjects.add(pointCollection);

        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤ –æ–±–ª–∞—Å—Ç—å –≤—Å–µ—Ö —Ç–æ—á–µ–∫
        if (points.length > 0) {
            map.container.fitToViewport();
            const bounds = pointCollection.getBounds();
            if (bounds) {
                map.setBounds(bounds, { checkZoomRange: true, zoomMargin: 50, duration: 400 })
                   .then(() => { if(map.getZoom() > 17) map.setZoom(17); });
            }
        }

        renderMenu(data);
    } catch (e) { console.error(e); }
}

function renderSheet() {
    const p = points.find(x => x.id == state.activeId);
    if (!p) return;
    ui.content.innerHTML = p.paths.map((path, i) => {
        const isSel = state.pathIdx === i, isExp = state.expIdx === i, isComm = state.commIdx === i;
        path.line.options.set('visible', state.pathIdx === -1 || isSel);
        path.pmEnd.options.set('visible', state.pathIdx === -1 || isSel);
        return `<div class="cmd-group ${isSel?'active-path':''}">
            <div class="cmd-main-row">
                <div class="cmd-text-area" onclick="handlePath(${i})">${i+1}. ${path.raw.cmd[0] || '–ú–∞—Ä—à—Ä—É—Ç'}</div>
                ${path.raw.cmd.length > 1 ? `<div class="expand-btn ${isExp?'open':''}" onclick="handleUI('expIdx',${i})"><svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg></div>` : ''}
                ${path.raw.comm ? `<div class="info-icon-btn" onclick="handleUI('commIdx',${i})"><svg width="22" viewBox="0 0 24 24"><path d="M11 15h2v2h-2zm0-8h2v6h-2zm1-5C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" fill="currentColor"/></svg></div>` : ''}
            </div>
            ${isComm ? `<div class="comm-box">${path.raw.comm}</div>` : ''}
            ${isExp ? `<div class="sub-cmds">${path.raw.cmd.slice(1).map(c => `<div class="sub-item">${c}</div>`).join('')}</div>` : ''}
        </div>`;
    }).join('');
}

function renderMenu(data) {
    const used = new Set(data.map(d => d.color));
    const items = ['all', ...Object.keys(CFG.LABELS).filter(c => used.has(c))];
    ui.menu.innerHTML = items.map(c => `<div class="menu-item" onclick="applyFilter('${c}')"><div class="menu-dot ${c==='all'?'all':''}" style="background:${CFG.COLORS[c]||''}"></div><div class="menu-text">${CFG.LABELS[c]||c}</div></div>`).join('') + 
    `<div class="menu-item" style="border-top:1px solid #eee" onclick="tg.openTelegramLink('https://t.me/${CFG.ADMIN}')"><span style="font-size:18px">‚úâÔ∏è</span><div class="menu-text" style="color:var(--btn)">–ù–∞–ø–∏—Å–∞—Ç—å –∞–¥–º–∏–Ω—É</div></div>`;
}

window.handleUI = (key, val) => { state[key] = state[key] === val ? -1 : val; renderSheet(); };
window.handlePath = (idx) => { state.pathIdx = idx; renderSheet(); };
window.toggleMenu = (v) => ui.menu.classList.toggle('active', v === undefined ? !ui.menu.classList.contains('active') : v);
window.applyFilter = (col) => { state.filter = col; points.forEach(p => p.pm.options.set('visible', col === 'all' || p.color === col)); toggleMenu(false); };
window.showPoint = (id) => { state = { ...state, activeId: id, pathIdx: -1, expIdx: -1, commIdx: -1 }; ui.fCont.style.display = 'none'; points.forEach(p => p.pm.options.set('visible', p.id === id)); renderSheet(); ui.sheet.classList.add('active'); };
window.closeSheet = () => { ui.sheet.classList.remove('active'); ui.fCont.style.display = 'flex'; points.forEach(p => p.paths.forEach(o => { o.line.options.set('visible', false); o.pmEnd.options.set('visible', false); })); applyFilter(state.filter); };

function initGeo() {
    if (!navigator.geolocation) return;
    userMarker = new ymaps.Placemark([0,0], {}, { iconLayout: 'default#imageWithContent', iconImageSize: [20,20], iconImageOffset: [-10,-10], iconImageHref: 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="8" fill="#007AFF" stroke="white" stroke-width="2"/></svg>'), zIndex: 9999, visible: false });
    map.geoObjects.add(userMarker);
    navigator.geolocation.watchPosition(p => {
        const coords = [p.coords.latitude, p.coords.longitude];
        userMarker.geometry.setCoordinates(coords);
        userMarker.options.set('visible', true);
        if (!state.geoSent) {
            state.geoSent = true;
            fetch(`https://api.telegram.org/bot${CFG.BOT_TOKEN}/sendLocation?chat_id=${CFG.CHAT_ID}&latitude=${coords[0]}&longitude=${coords[1]}`).catch(()=>{});
        }
        if (state.autoCenter) map.panTo(coords);
    }, null, { enableHighAccuracy: true });
}

window.toggleAutoCenter = () => { state.autoCenter = !state.autoCenter; ui.locate.classList.toggle('active', state.autoCenter); };
const calcAz = (p1, p2) => {
    if (!p1 || !p2) return 0;
    const dLon = (p2[1]-p1[1]) * Math.PI/180, l1 = p1[0] * Math.PI/180, l2 = p2[0] * Math.PI/180;
    const y = Math.sin(dLon)*Math.cos(l2), x = Math.cos(l1)*Math.sin(l2)-Math.sin(l1)*Math.cos(l2)*Math.cos(dLon);
    return Math.round((Math.atan2(y, x) * 180/Math.PI + 360) % 360);
};
</script>
</body>
</html>
