<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Route Viewer Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU&suppressMapOpenBlock=true"></script>
    <style>
        :root { 
            --bg: var(--tg-theme-bg-color, #f5f5f7); 
            --btn: var(--tg-theme-button-color, #007AFF); 
            --btn-txt: var(--tg-theme-button-text-color, #fff);
            --sheet-bg: rgba(255, 255, 255, 0.85);
            --text-main: #1d1d1f;
            --text-sub: #86868b;
            --accent: #007AFF;
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            overflow: hidden; background: #000; 
            position: fixed;
        }

        #map { position: absolute; inset: 0; z-index: 1; }
        [class*="-copyrights-pane"], [class*="-map-copyrights-promo"], [class*="-controls-pane"] { display: none !important; }

        /* Floating Buttons */
        .filter-container { position: absolute; bottom: 40px; right: 16px; z-index: 2000; display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 12px; }
        .map-btn { width: 56px; height: 56px; border-radius: 50%; background: rgba(0,0,0,.75); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 8px 32px rgba(0,0,0,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .map-btn:active { transform: scale(0.9); }
        .map-btn svg { fill: white; width: 26px; }
        .map-btn.active { background: var(--btn); border-color: transparent; }

        /* Filter Menu */
        #filterMenu { background: var(--sheet-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); padding: 8px; display: none; flex-direction: column; gap: 2px; border: 1px solid rgba(255,255,255,0.4); margin-bottom: 12px; min-width: 240px; max-height: 50vh; overflow-y: auto; }
        #filterMenu.active { display: flex; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .menu-item { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 12px 16px; border-radius: 16px; transition: background 0.2s; }
        .menu-item:active { background: rgba(0,0,0,0.05); }
        .menu-dot { width: 14px; height: 14px; border-radius: 4px; flex-shrink: 0; }
        .menu-dot.all { background: linear-gradient(135deg, #007aff, #5856d6, #ff2d55); }
        .menu-text { font-size: 15px; color: var(--text-main); font-weight: 500; }

        /* Minimalist Info Sheet */
        #infoSheet { 
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 2500; 
            background: var(--sheet-bg); 
            backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%);
            border-radius: 32px 32px 0 0; 
            transform: translateY(100%); 
            transition: transform .5s cubic-bezier(0.16, 1, 0.3, 1); 
            max-height: 85vh; overflow-y: auto; 
            padding: 0 16px 40px; 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
            box-sizing: border-box;
            touch-action: none; /* –£–ø—Ä–∞–≤–ª—è–µ–º –∂–µ—Å—Ç–∞–º–∏ —á–µ—Ä–µ–∑ JS –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è */
        }
        #infoSheet.active { transform: translateY(0); }
        
        /* –ó–æ–Ω–∞ –¥–ª—è —Å–≤–∞–π–ø–∞ */
        .sheet-header { 
            width: 100%; height: 40px; cursor: grab; 
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .sheet-handle { width: 36px; height: 5px; background: rgba(0,0,0,0.15); border-radius: 3px; }
        
        #sheetContent { touch-action: pan-y; }

        /* Focus-based Card List */
        .cmd-group { 
            position: relative;
            margin-bottom: 6px;
            border-radius: 16px; 
            background: rgba(255,255,255,0.4); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0,0,0,0.03);
            opacity: 1;
        }
        
        #sheetContent.has-selection .cmd-group:not(.active-path) {
            opacity: 0.35;
            transform: scale(0.98);
            filter: grayscale(0.5);
        }

        .cmd-group.active-path { 
            background: #fff; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
            border-color: var(--accent);
            opacity: 1 !important;
            transform: scale(1) !important;
            filter: none !important;
        }
        
        .cmd-main-row { display: flex; align-items: center; min-height: 52px; padding: 4px 8px 4px 12px; }
        
        .cmd-info { flex: 1; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .cmd-num-circle { 
            width: 24px; height: 24px; border-radius: 50%; background: rgba(0,122,255,0.1); 
            color: var(--accent); font-size: 13px; font-weight: 800; 
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .active-path .cmd-num-circle { background: var(--accent); color: #fff; }
        
        .cmd-title { font-size: 15px; font-weight: 600; color: var(--text-main); line-height: 1.2; }
        
        /* Minimalist Actions */
        .action-bar { display: flex; gap: 2px; }
        .icon-btn { 
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; 
            border-radius: 50%; transition: all 0.2s; cursor: pointer; color: var(--text-sub);
        }
        .icon-btn:active { background: rgba(0,0,0,0.05); }
        .icon-btn.active { color: var(--accent); background: rgba(0,122,255,0.1); }
        .icon-btn.has-data { color: #ff9500; }

        /* Nested Content */
        .nested-content { 
            padding: 4px 12px 16px 46px; 
            animation: fadeInScale 0.3s ease-out;
        }
        @keyframes fadeInScale { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .comm-text { 
            font-size: 14px; color: #555; line-height: 1.4;
            padding: 10px 12px; background: #fdf6e3; border-radius: 10px;
            border-left: 3px solid #ff9500; margin-bottom: 8px;
        }
        
        .sub-steps { display: flex; flex-direction: column; gap: 6px; }
        .step-item { 
            font-size: 14px; color: var(--text-main); font-weight: 500;
            display: flex; align-items: flex-start; gap: 8px;
        }
        .step-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); margin-top: 6px; flex-shrink: 0; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="filter-container" id="fCont">
    <div id="filterTrigger" class="map-btn" onclick="toggleMenu()">
        <svg viewBox="0 0 24 24"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/></svg>
    </div>
    <div id="locateBtn" class="map-btn" onclick="toggleAutoCenter()">
        <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
    </div>
    <div id="filterMenu"></div>
</div>

<div id="infoSheet">
    <div class="sheet-header" id="sheetHeader">
        <div class="sheet-handle"></div>
    </div>
    <div id="sheetContent"></div>
</div>

<script>
/** * CONFIGURATION */
const CFG = {
    BOT_TOKEN: "7860806384:AAEYRKqdPUsUz9npN3MmyEYKH-rTHISeHbs",
    CHAT_ID: "5180466640",
    ADMIN: "Eliseev_I_A",
    DATA_URL: "https://raw.githubusercontent.com/yvayvapyvapyva/test/refs/heads/main/roads/%D0%BF%D0%B5%D1%80%D0%B5%D0%BA%D1%80%D0%B5%D1%81%D1%82%D0%BA%D0%B8.json",
    COLORS: { Gold: '#FFD700', Blue: '#007AFF', Red: '#FF3B30', Lime: '#34C759', Fuchsia: '#AF52DE', Orange: '#FF9500', Purple: '#5856D6', Cyan: '#5AC8FA', Brown: '#A2845E', Grey: '#8E8E93' },
    LABELS: { all: "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë", Gold: "–ú–∞–Ω–µ–≤—Ä—ã –Ω–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ", Blue: "–†–∞–∑–≤–æ—Ä–æ—Ç –≤–Ω–µ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞", Red: "–†–∞–∑–≥–æ–Ω –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏", Fuchsia: "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—á–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –ø–æ–¥—ä–µ–º–µ", Orange: "–õ–µ–≤—ã–µ –∏ –ø—Ä–∞–≤—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã", Purple: "–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞ –∏ –≥–∞—Ä–∞–∂", Cyan: "–†–∞–∑–≤–æ—Ä–æ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ" }
};

/** * STATE */
let map, points = [], userMarker, pointCollection;
let state = { filter: 'all', activeId: null, pathIdx: -1, expIdx: -1, commIdx: -1, autoCenter: false, geoSent: false };

const ui = {
    menu: document.getElementById('filterMenu'),
    sheet: document.getElementById('infoSheet'),
    header: document.getElementById('sheetHeader'),
    content: document.getElementById('sheetContent'),
    fCont: document.getElementById('fCont'),
    locate: document.getElementById('locateBtn')
};

const tg = window.Telegram.WebApp;

/** * INITIALIZATION */
ymaps.ready(() => {
    tg.expand();
    tg.ready();
    
    map = new ymaps.Map("map", { 
        center: [55.75, 37.62], zoom: 10, 
        type: 'yandex#satellite', controls: [] 
    });
    
    pointCollection = new ymaps.GeoObjectCollection();
    map.geoObjects.add(pointCollection);
    
    map.events.add('click', e => e.get('target') === map && (closeSheet(), toggleMenu(false)));
    
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        sendStats(tg.initDataUnsafe.user);
    }
    
    initGeo();
    initSwipeToClose();
    loadData();
});

/** * SWIPE TO CLOSE LOGIC */
function initSwipeToClose() {
    let startY = 0;
    let currentY = 0;
    let isDragging = false;

    const onStart = (e) => {
        startY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç—è–Ω—É—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–∫—Ä–æ–ª–ª –≤–≤–µ—Ä—Ö—É
        if (ui.sheet.scrollTop <= 0) {
            isDragging = true;
            ui.sheet.style.transition = 'none';
        }
    };

    const onMove = (e) => {
        if (!isDragging) return;
        currentY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        let diff = currentY - startY;
        
        if (diff > 0) {
            ui.sheet.style.transform = `translateY(${diff}px)`;
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –≤–Ω–∏–∑
            if (e.cancelable) e.preventDefault();
        }
    };

    const onEnd = () => {
        if (!isDragging) return;
        isDragging = false;
        ui.sheet.style.transition = 'transform .5s cubic-bezier(0.16, 1, 0.3, 1)';
        
        const diff = currentY - startY;
        if (diff > 120) { // –ï—Å–ª–∏ –ø—Ä–æ—Ç–∞—â–∏–ª–∏ –±–æ–ª—å—à–µ 120px ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º
            closeSheet();
        } else {
            ui.sheet.style.transform = 'translateY(0)';
        }
    };

    // –í–µ—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞ –≤–µ—Å—å –ª–∏—Å—Ç, –Ω–æ –ª–æ–≥–∏–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ 0
    ui.sheet.addEventListener('touchstart', onStart, {passive: false});
    ui.sheet.addEventListener('touchmove', onMove, {passive: false});
    ui.sheet.addEventListener('touchend', onEnd);
    
    // –¢–∞–∫–∂–µ –Ω–∞ –º—ã—à–∫—É –¥–ª—è —Ç–µ—Å—Ç–æ–≤
    ui.sheet.addEventListener('mousedown', onStart);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onEnd);
}

/** * DATA LOADING */
async function loadData() {
    try {
        const response = await fetch(CFG.DATA_URL);
        const data = await response.json();
        
        points = data.map(d => {
            const col = CFG.COLORS[d.color] || d.color;
            const p = { ...d, hexColor: col, paths: [] };
            
            p.pm = new ymaps.Placemark([d.lat, d.lon], {}, {
                iconLayout: 'default#imageWithContent', 
                iconImageSize: [40, 40], 
                iconImageOffset: [-20, -20],
                iconImageHref: getIcon(col, `${d.id}${d.paths?.some(p=>p.comm)?'!':''}`, d.az, false)
            });
            p.pm.events.add('click', () => showPoint(d.id));
            pointCollection.add(p.pm);

            d.paths.forEach((pth, i) => {
                const last = pth.pts.length - 1;
                const az = calcAz(pth.pts[last-1], pth.pts[last]);
                const line = new ymaps.Polyline(pth.pts, {}, { strokeColor: col, strokeWidth: 5, strokeOpacity: 0.8, visible: false, interactive: false });
                const pmEnd = new ymaps.Placemark(pth.pts[last], {}, {
                    iconLayout: 'default#imageWithContent', 
                    iconImageSize: [34, 34], 
                    iconImageOffset: [-17, -17],
                    iconImageHref: getIcon(col, String(i+1), az, true), 
                    visible: false, interactive: false
                });
                
                const safePth = { ...pth, cmd: Array.isArray(pth.cmd) ? pth.cmd : [] };
                p.paths.push({ line, pmEnd, raw: safePth });
                map.geoObjects.add(line).add(pmEnd);
            });
            return p;
        });

        if (points.length > 0) {
            const bounds = pointCollection.getBounds();
            if (bounds) {
                map.setBounds(bounds, { checkZoomRange: true, zoomMargin: 60, duration: 400 })
                   .then(() => { if(map.getZoom() > 17) map.setZoom(17); });
            }
        }
        renderMenu(data);
    } catch (e) { console.error(e); }
}

/** * UI RENDERING */
function renderSheet() {
    const p = points.find(x => x.id == state.activeId);
    if (!p) return;

    if (state.pathIdx !== -1) ui.content.classList.add('has-selection');
    else ui.content.classList.remove('has-selection');

    ui.content.innerHTML = p.paths.map((path, i) => {
        const isSel = state.pathIdx === i, isExp = state.expIdx === i, isComm = state.commIdx === i;
        path.line.options.set('visible', state.pathIdx === -1 || isSel);
        path.pmEnd.options.set('visible', state.pathIdx === -1 || isSel);
        
        const titleText = (path.raw.cmd && path.raw.cmd.length > 0) ? path.raw.cmd[0] : `–ú–∞—Ä—à—Ä—É—Ç ${i + 1}`;
        const hasExtra = path.raw.cmd && path.raw.cmd.length > 1;

        return `
        <div class="cmd-group ${isSel?'active-path':''}">
            <div class="cmd-main-row">
                <div class="cmd-info" onclick="handlePath(${i})">
                    <div class="cmd-num-circle">${i+1}</div>
                    <div class="cmd-title">${titleText}</div>
                </div>
                <div class="action-bar">
                    ${path.raw.comm ? `
                        <div class="icon-btn ${isComm?'active':'has-data'}" onclick="handleUI('commIdx',${i})">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        </div>` : ''}
                    ${hasExtra ? `
                        <div class="icon-btn ${isExp?'active':''}" onclick="handleUI('expIdx',${i})">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>` : ''}
                </div>
            </div>
            
            ${(isComm || isExp) ? `
                <div class="nested-content">
                    ${isComm ? `<div class="comm-text">${path.raw.comm}</div>` : ''}
                    ${isExp ? `
                        <div class="sub-steps">
                            ${path.raw.cmd.slice(1).map(c => `
                                <div class="step-item"><div class="step-dot"></div>${c}</div>
                            `).join('')}
                        </div>` : ''}
                </div>
            ` : ''}
        </div>`;
    }).join('');
}

function renderMenu(data) {
    const used = new Set(data.map(d => d.color));
    const items = ['all', ...Object.keys(CFG.LABELS).filter(c => used.has(c))];
    ui.menu.innerHTML = items.map(c => `
        <div class="menu-item" onclick="applyFilter('${c}')">
            <div class="menu-dot ${c==='all'?'all':''}" style="background:${CFG.COLORS[c]||''}"></div>
            <div class="menu-text">${CFG.LABELS[c]||c}</div>
        </div>`).join('') + 
    `<div class="menu-item" style="border-top:1px solid rgba(0,0,0,0.05); margin-top:4px; padding-top:16px;" onclick="contactAdmin()">
        <span style="font-size:18px">‚úâÔ∏è</span>
        <div class="menu-text" style="color:var(--btn)">–ù–∞–ø–∏—Å–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</div>
    </div>`;
}

/** * ACTIONS */
window.handleUI = (key, val) => { 
    state.pathIdx = val;
    if (key === 'expIdx' || key === 'commIdx') {
        const other = key === 'expIdx' ? 'commIdx' : 'expIdx';
        state[other] = -1;
    }
    state[key] = state[key] === val ? -1 : val; 
    renderSheet(); 
};
window.handlePath = (idx) => { 
    state.pathIdx = (state.pathIdx === idx ? -1 : idx); 
    state.expIdx = -1;
    state.commIdx = -1;
    renderSheet(); 
};
window.toggleMenu = (v) => ui.menu.classList.toggle('active', v === undefined ? !ui.menu.classList.contains('active') : v);
window.applyFilter = (col) => { state.filter = col; points.forEach(p => p.pm.options.set('visible', col === 'all' || p.color === col)); toggleMenu(false); };
window.showPoint = (id) => { 
    state = { ...state, activeId: id, pathIdx: -1, expIdx: -1, commIdx: -1 }; 
    ui.fCont.style.display = 'none'; 
    points.forEach(p => p.pm.options.set('visible', p.id === id)); 
    renderSheet(); 
    ui.sheet.scrollTop = 0;
    ui.sheet.style.transform = 'translateY(0)';
    ui.sheet.classList.add('active'); 
};
window.closeSheet = () => { 
    ui.sheet.classList.remove('active'); 
    ui.sheet.style.transform = 'translateY(100%)';
    ui.fCont.style.display = 'flex'; 
    setTimeout(() => { 
        points.forEach(p => p.paths.forEach(o => { o.line.options.set('visible', false); o.pmEnd.options.set('visible', false); })); 
        applyFilter(state.filter); 
    }, 300); 
};
window.contactAdmin = () => { const url = `https://t.me/${CFG.ADMIN}`; if(tg.openTelegramLink) tg.openTelegramLink(url); else window.open(url); };

/** * UTILS */
const getIcon = (col, txt, az, isEnd) => {
    const isRed = txt.includes('!') && !isEnd;
    const size = isEnd ? 34 : 40;
    const center = size / 2;
    const cleanTxt = txt.replace('!', '');
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}">
        <g transform="rotate(${az},${center},${center})">
            <polygon points="${center},2 ${center+10},${size-5} ${center},${size-14} ${center-10},${size-5}" fill="${col}" stroke="${isEnd?'white':'black'}" stroke-width="1.5"/>
        </g>
        <circle cx="${center}" cy="${center}" r="${isEnd?7:9}" fill="${col}" stroke="${isEnd?'white':'black'}" stroke-width="1"/>
        <text x="${center}" y="${center + 0.5}" font-size="9" font-family="Arial" font-weight="900" text-anchor="middle" dominant-baseline="middle" fill="${isRed?'#FF3B30':'#000'}" stroke="white" stroke-width="2" style="paint-order:stroke fill">${cleanTxt}</text>
    </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
};

function initGeo() {
    if (!navigator.geolocation) return;
    userMarker = new ymaps.Placemark([0,0], {}, { iconLayout: 'default#imageWithContent', iconImageSize: [20,20], iconImageOffset: [-10,-10], iconImageHref: 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="8" fill="#007AFF" stroke="white" stroke-width="2"/><circle cx="10" cy="10" r="10" fill="rgba(0,122,255,0.2)"/></svg>'), zIndex: 9999, visible: false });
    map.geoObjects.add(userMarker);
    navigator.geolocation.watchPosition(p => {
        const coords = [p.coords.latitude, p.coords.longitude];
        userMarker.geometry.setCoordinates(coords);
        userMarker.options.set('visible', true);
        if (!state.geoSent && tg.initDataUnsafe?.user) {
            state.geoSent = true;
            fetch(`https://api.telegram.org/bot${CFG.BOT_TOKEN}/sendLocation?chat_id=${CFG.CHAT_ID}&latitude=${coords[0]}&longitude=${coords[1]}`).catch(()=>{});
        }
        if (state.autoCenter) map.panTo(coords);
    }, null, { enableHighAccuracy: true });
}

window.toggleAutoCenter = () => { state.autoCenter = !state.autoCenter; ui.locate.classList.toggle('active', state.autoCenter); };

const calcAz = (p1, p2) => {
    if (!p1 || !p2) return 0;
    const dLon = (p2[1]-p1[1]) * Math.PI/180, l1 = p1[0] * Math.PI/180, l2 = p2[0] * Math.PI/180;
    const y = Math.sin(dLon)*Math.cos(l2), x = Math.cos(l1)*Math.sin(l2)-Math.sin(l1)*Math.cos(l2)*Math.cos(dLon);
    return Math.round((Math.atan2(y, x) * 180/Math.PI + 360) % 360);
};

const sendStats = (u) => {
    const text = `üöÄ *–ù–æ–≤—ã–π –≤—Ö–æ–¥*\nüë§ ${u.first_name}\nüÜî \`${u.id}\`\nüîó @${u.username||'–Ω–µ—Ç'}\nüì± ${tg.platform || 'web'}`;
    fetch(`https://api.telegram.org/bot${CFG.BOT_TOKEN}/sendMessage?chat_id=${CFG.CHAT_ID}&text=${encodeURIComponent(text)}&parse_mode=Markdown`).catch(() => {});
};
</script>
</body>
</html>
